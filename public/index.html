<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>TRADE-X | LIVE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; display: flex; flex-direction: column; }
        
        /* Overlay for "Standby" or "Overlay" mode */
        #default-screen { position: fixed; inset: 0; background: #fff; z-index: 10000; display: flex; align-items: center; justify-content: center; transition: opacity 0.6s ease, visibility 0.6s; }
        .logo-glow { font-size: 7rem; font-weight: 900; color: var(--primary); animation: glowPulse 3s infinite; }
        @keyframes glowPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* External Screen Frame (No Redirection) */
        #external-frame { position: fixed; inset: 0; width: 100%; height: 100%; border: none; z-index: 9999; display: none; background: white; }

        .header { height: 8vh; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid #e2e8f0; }
        .main { flex: 1; display: flex; padding: 20px; gap: 20px; height: 92vh; overflow: hidden; }
        .chart-box { flex: 3; background: #fff; border-radius: 24px; padding: 25px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .list-box { flex: 1; background: #fff; border-radius: 24px; padding: 25px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; max-width: 450px; height: 100%; overflow: hidden; }
        
        #content { flex: 1; overflow-y: auto; margin-top: 15px; padding-right: 10px; }
        #content::-webkit-scrollbar { width: 8px; }
        #content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .team-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; font-weight: 700; border-left: 5px solid var(--primary); }
        #liveChart { flex: 1; width: 100% !important; height: 100% !important; }
        #main-wrapper { transition: opacity 0.6s ease; opacity: 0; flex: 1; display: flex; flex-direction: column; height: 100vh; }
    </style>
</head>
<body>
    <div id="default-screen"><div class="logo-glow">TRADE-X 2.0</div></div>
    
    <iframe id="external-frame"></iframe>

    <div id="main-wrapper">
        <div class="header"><h1 class="fw-bold m-0 text-primary">TRADE-X</h1><span class="badge bg-primary rounded-pill px-3 py-2">LIVE MARKET</span></div>
        <div class="main">
            <div class="chart-box"><canvas id="liveChart"></canvas></div>
            <div class="list-box"><h4 id="hText" class="fw-bold border-bottom pb-2">LEADERBOARD</h4><div id="content"></div></div>
        </div>
    </div>

    <script>
        const socket = io(); let chart; let currentView = "";
        async function update() {
            const r = await fetch('/api/get_data'); const d = await r.json(); const s = d.screenState;
            const defScreen = document.getElementById('default-screen');
            const mainWrap = document.getElementById('main-wrapper');
            const extFrame = document.getElementById('external-frame');

            // Handle External HTML Screens (Rules/Rounds) via iFrame
            if (s.activeView && (s.activeView.endsWith('.html') || s.activeView.includes('screen/'))) {
                if (extFrame.src !== window.location.origin + '/' + s.activeView) {
                    extFrame.src = s.activeView;
                }
                extFrame.style.display = "block";
                mainWrap.style.opacity = "0";
                defScreen.style.opacity = "0";
                return;
            } else {
                extFrame.style.display = "none";
                extFrame.src = ""; // Clear src when not in use
            }

            // Standard Screen Logic (Trends/Wealth)
            if(s.overlayActive) { 
                defScreen.style.opacity = "1"; 
                defScreen.style.visibility = "visible"; 
                mainWrap.style.opacity = "0"; 
                return; 
            } else { 
                defScreen.style.opacity = "0"; 
                defScreen.style.visibility = "hidden"; 
                mainWrap.style.opacity = "1"; 
            }

            const v = s.activeView; const ctx = document.getElementById('liveChart').getContext('2d');
            let labels = d.companies[0].history.map((_, i) => "R" + i), datasets = [], type = 'line';
            
            if (v === 'market_line') {
                datasets = d.companies.map(c => ({ label: c.name, data: c.history, borderColor: c.color, tension: 0.4, borderWidth: 4 }));
                document.getElementById('content').innerHTML = d.companies.map(c => `<div class="team-row" style="border-left-color:${c.color}"><span>${c.name}</span><strong>${c.price}</strong></div>`).join('');
                document.getElementById('hText').innerText = "LIVE PRICES";
            } else {
                const chartTeams = d.teams; 
                const sortedTeams = [...d.teams].sort((a, b) => b.wealth - a.wealth);

                if (v === 'wealth_line') {
                    datasets = chartTeams.map(t => ({ label: t.name, data: t.wealth_history, tension: 0.4, borderWidth: 3 }));
                } else { 
                    type = 'bar'; 
                    labels = chartTeams.map(t => t.name);
                    datasets = d.companies.map((c, i) => ({ 
                        label: c.name, 
                        data: chartTeams.map(t => (t.stocks[i] || 0) * c.price), 
                        backgroundColor: c.color, 
                        stack: 'S' 
                    })); 
                    datasets.push({ label: 'Purse', data: chartTeams.map(t => t.purse), backgroundColor: '#2563eb', stack: 'S' }); 
                }
                document.getElementById('content').innerHTML = sortedTeams.map(t => `<div class="team-row"><span>${t.name}</span><strong>${Math.floor(t.wealth)}</strong></div>`).join('');
                document.getElementById('hText').innerText = "LEADERBOARD";
            }

            const chartOpt = { 
                maintainAspectRatio: false, animation: false, 
                plugins: { legend: { display: true, position: 'top', labels: { font: { size: 14, weight: 'bold' } } } },
                scales: { y: { beginAtZero: true, grid: { color: '#e2e8f0' } } }
            };

            if (chart && currentView === v && chart.config.type === type) { 
                chart.data.labels = labels; 
                chart.data.datasets = datasets; 
                chart.update('none'); 
            } else { 
                if (chart) chart.destroy(); 
                chart = new Chart(ctx, { type, data: { labels, datasets }, options: chartOpt }); 
                currentView = v; 
            }
        }
        socket.on('data_update', update); update();
    </script>
</body>
</html>
